---
  - name: collect runner vm ip address
    hosts: localhost
    vars:
      engine_fqdn: "{{ ovirt_engine_url }}"
      engine_user: "{{ ovirt_engine_username }}"
      engine_password: "{{ ovirt_engine_password }}"
    collections:
      - ovirt.ovirt
      - ansible.posix

    tasks:
      - name: login to ovirt
        include_role:
          name: okd-on-ovirt
          tasks_from: login_to_ovirt 
          apply:
            tags:
              - always
        tags:
          - always          

      - ovirt_vm_info:
          pattern: name=gh_runner_vm and cluster="{{ovirt_cluster_name}}"
          auth: "{{ovirt_auth}}"
          follow: ['reported_devices']
        register: result
        until: "result.ovirt_vms | ovirt.ovirt.ovirtvmipv4 | length > 0"
        retries: 10
        delay: 30

      - set_fact:
          collected_address: "{{ result.ovirt_vms | ovirt.ovirt.ovirtvmipv4 }}"
    
      - debug: msg="got VM IP {{collected_address}}"

      - blockinfile:
          path: /tmp/ssh-conf
          create: yes
          mode: 600
          content: |
            Host ovirt-proxy-vm-1.rhv45.gcp.devcluster.openshift.com
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
              IdentityFile /tmp/id_ssh_rsa

            Host 192.168.225.*
              ProxyJump installer@ovirt-proxy-vm-1.rhv45.gcp.devcluster.openshift.com
              User root
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
              IdentityFile /tmp/id_ssh_rsa
        tags:
          - always          

      - name: Add a host alias that we reach through a tunnel
        add_host:
          hostname: '{{ collected_address }}'
          name: test-vm
          ansible_ssh_host: '{{ collected_address }}'
          ansible_ssh_user: root    
          ansible_ssh_common_args: '-F /tmp/ssh-conf'      
       
      - name: check connectivity to the VM
        ping:
        delegate_to: test-vm
  - name: register gh-action runner
    hosts: localhost
    vars:
        runner_user: root

    roles:
      - role: monolithprojects.github_actions_runner
        delegate_to: test-vm